<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Dispensa"/>
  <meta name="theme-color" content="#0f1117"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="apple-touch-icon" href="/icon-192.png"/>
  <title>Dispensa di Casa</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; overflow: hidden; }
    body { background: #0f1117; font-family: 'DM Sans', sans-serif; }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #2e3244; border-radius: 3px; }
    input:focus, select:focus, textarea:focus {
      border-color: #4c6ef5 !important;
      box-shadow: 0 0 0 2px #4c6ef514;
    }
    button { font-family: 'DM Sans', sans-serif; }
    button:hover { opacity: 0.8; }
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap');
  </style>
</head>
<body>
<div id="root"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBZbE9KO3Ku4paZK3b4gZbd5xY_ukaB-A8",
    authDomain: "dispenso-2aa11.firebaseapp.com",
    databaseURL: "https://dispenso-2aa11-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dispenso-2aa11",
    storageBucket: "dispenso-2aa11.firebasestorage.app",
    messagingSenderId: "888240634833",
    appId: "1:888240634833:web:afeb1df0fee8e144bdbef0",
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  window.__DB__      = db;
  window.__ref__     = ref;
  window.__onValue__ = onValue;
  window.__set__     = set;
  window.__FIREBASE_READY__ = true;
  // Notifica React (potrebbe gi√† essere in ascolto, o arrivare dopo)
  window.dispatchEvent(new Event("firebase-ready"));
</script>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

/* ‚îÄ‚îÄ persistence: Firebase realtime sync ‚îÄ‚îÄ */
function useFirebase(key, def) {
  const [val, setValState] = useState(def);
  const [ready, setReady] = useState(false);

  useEffect(() => {
    let unsub = null;
    let cancelled = false;

    const init = () => {
      if (cancelled) return;
      const dbRef = window.__ref__(window.__DB__, `dispensa/${key}`);
      unsub = window.__onValue__(dbRef, snap => {
        if (cancelled) return;
        const data = snap.val();
        // Se il db √® vuoto (null) usa i default E segna come ready
        setValState(data !== null && data !== undefined ? data : def);
        setReady(true);
      }, (error) => {
        // Anche in caso di errore, segna ready con i default
        console.error("Firebase error:", error);
        setValState(def);
        setReady(true);
      });
    };

    if (window.__FIREBASE_READY__) {
      init();
    } else {
      // Polling ogni 100ms finch√© Firebase non √® pronto (gestisce race condition)
      const poll = setInterval(() => {
        if (window.__FIREBASE_READY__) {
          clearInterval(poll);
          init();
        }
      }, 100);
      return () => { cancelled = true; clearInterval(poll); if (unsub) unsub(); };
    }

    return () => { cancelled = true; if (unsub) unsub(); };
  }, [key]);

  const setVal = (newValOrFn) => {
    setValState(prev => {
      const next = typeof newValOrFn === "function" ? newValOrFn(prev) : newValOrFn;
      window.__set__(window.__ref__(window.__DB__, `dispensa/${key}`), next).catch(console.error);
      return next;
    });
  };

  return [val, setVal, ready];
}

/* ‚îÄ‚îÄ tree helpers ‚îÄ‚îÄ */
function genId() { return Math.random().toString(36).slice(2, 9); }

function findNode(nodes, id) {
  for (const n of nodes) {
    if (n.id === id) return n;
    const found = findNode(n.children || [], id);
    if (found) return found;
  }
  return null;
}

function mapTree(nodes, fn) {
  return nodes.map(n => fn({ ...n, children: mapTree(n.children || [], fn) }));
}

function removeNode(nodes, id) {
  return nodes.filter(n => n.id !== id).map(n => ({ ...n, children: removeNode(n.children || [], id) }));
}

function addChildTo(nodes, parentId, child) {
  return nodes.map(n => {
    if (n.id === parentId) return { ...n, children: [...(n.children || []), child] };
    return { ...n, children: addChildTo(n.children || [], parentId, child) };
  });
}

function renameNode(nodes, id, name) {
  return mapTree(nodes, n => n.id === id ? { ...n, name } : n);
}

// Flat list of all paths: [{id, label, depth, path}]
function flattenPaths(nodes, prefix = "", depth = 0) {
  const out = [];
  for (const n of nodes) {
    const path = prefix ? `${prefix} ‚Ä∫ ${n.name}` : n.name;
    out.push({ id: n.id, label: path, name: n.name, depth, path });
    out.push(...flattenPaths(n.children || [], path, depth + 1));
  }
  return out;
}

// All ancestor ids of a given id
function ancestorIds(nodes, targetId, acc = []) {
  for (const n of nodes) {
    if (n.id === targetId) return acc;
    const found = ancestorIds(n.children || [], targetId, [...acc, n.id]);
    if (found) return found;
  }
  return null;
}

/* ‚îÄ‚îÄ defaults ‚îÄ‚îÄ */
const DEFAULT_LOCATIONS = [
  { id: "l1", name: "Cucina", children: [
    { id: "l1a", name: "Anta sinistra", children: [] },
    { id: "l1b", name: "Anta destra", children: [] },
  ]},
  { id: "l2", name: "Dispensa", children: [] },
  { id: "l3", name: "Frigo", children: [
    { id: "l3a", name: "Cassetto verdure", children: [] },
  ]},
  { id: "l4", name: "Freezer", children: [] },
  { id: "l5", name: "Cantina", children: [] },
];

const DEFAULT_TAGS = ["pasta","riso","legumi","cereali","conserve","latticini","carne","pesce","verdura","frutta","dolci","bevande","spezie","condimenti","surgelati"];

const DEFAULT_ITEMS = [
  { id: 1, name: "Pasta Barilla", quantity: 3, unit: "confezioni", locationId: "l2", tags: ["pasta","cereali"], notes: "" },
  { id: 2, name: "Olio EVO", quantity: 1, unit: "bottiglie", locationId: "l1a", tags: ["condimenti"], notes: "Extravergine" },
  { id: 3, name: "Latte intero", quantity: 2, unit: "L", locationId: "l3", tags: ["latticini"], notes: "" },
];

const UNITS = ["pz","kg","g","L","mL","confezioni","lattine","bottiglie","buste","vasetti","scatole"];

/* ‚îÄ‚îÄ icons ‚îÄ‚îÄ */
const Ic = ({ d, size = 16, color }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{flexShrink:0}}>
    <path d={d}/>
  </svg>
);
const D = {
  search:"M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z",
  plus:"M12 5v14M5 12h14",
  edit:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z",
  trash:"M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6",
  folder:"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z",
  folderOpen:"M5 19a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2 3h8a2 2 0 0 1 2 2v1M3 19l3-8h15l-3 8H3z",
  close:"M18 6L6 18M6 6l12 12",
  warn:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01",
  grid:"M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z",
  list:"M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01",
  caret:"M9 18l6-6-6-6",
  settings:"M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z",
};

/* ‚îÄ‚îÄ style helpers ‚îÄ‚îÄ */
const S = {
  inp: (extra={}) => ({ width:"100%", background:"#1a1d27", border:"1px solid #2e3244", color:"#dde1f0", padding:"9px 12px", borderRadius:7, fontFamily:"'DM Sans',sans-serif", fontSize:14, outline:"none", boxSizing:"border-box", ...extra }),
  btn: (v="primary", extra={}) => ({
    padding:"8px 16px", borderRadius:7, border:"none", fontFamily:"'DM Sans',sans-serif", fontSize:13, fontWeight:500, cursor:"pointer",
    ...(v==="primary"&&{background:"#4c6ef5",color:"#fff"}),
    ...(v==="ghost"&&{background:"transparent",color:"#7b82a0",border:"1px solid #2e3244"}),
    ...(v==="danger"&&{background:"#e05252",color:"#fff"}),
    ...(v==="subtle"&&{background:"#1e2233",color:"#7b82a0"}),
    ...(v==="icon"&&{background:"none",border:"none",color:"#5a6080",padding:5,display:"flex",alignItems:"center",justifyContent:"center"}),
    ...extra
  }),
};

/* ‚îÄ‚îÄ components ‚îÄ‚îÄ */
function Modal({ children, onClose, width=500 }) {
  return (
    <div onClick={onClose} className="modal-outer" style={{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:300,backdropFilter:"blur(4px)"}}>
      <div onClick={e=>e.stopPropagation()} className="modal-inner" style={{background:"#161920",border:"1px solid #2e3244",borderRadius:12,padding:28,width:`min(${width}px,95vw)`,maxHeight:"90vh",overflowY:"auto",boxShadow:"0 28px 70px rgba(0,0,0,.55)"}}>
        {children}
      </div>
    </div>
  );
}

function Lbl({children,mt=14}) {
  return <div style={{fontSize:11,fontWeight:600,color:"#5a6080",textTransform:"uppercase",letterSpacing:"0.1em",marginTop:mt,marginBottom:6}}>{children}</div>;
}

function TagPill({ label, active, onClick, onRemove, small }) {
  return (
    <span style={{display:"inline-flex",alignItems:"center",gap:3,padding:small?"2px 8px":"3px 10px",borderRadius:20,fontSize:small?11:12,fontWeight:500,cursor:onClick?"pointer":"default",background:active?"#4c6ef518":"#1a1d27",border:`1px solid ${active?"#4c6ef5":"#2e3244"}`,color:active?"#7d9cf8":"#5a6080",transition:"all .15s",userSelect:"none",whiteSpace:"nowrap"}} onClick={onClick}>
      {label}
      {onRemove&&<span onClick={e=>{e.stopPropagation();onRemove();}} style={{cursor:"pointer",opacity:.6,fontSize:14,lineHeight:1,marginLeft:1}}>√ó</span>}
    </span>
  );
}

function QtyBar({ value, unit, onChange }) {
  const pct = Math.min(value/10,1);
  const col = value===0?"#e05252":value<=2?"#f5a623":"#4c6ef5";
  return (
    <div>
      <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:5}}>
        <button onClick={()=>onChange(Math.max(0,value-1))} style={{width:28,height:28,borderRadius:6,border:"1px solid #2e3244",background:"#1a1d27",color:"#7b82a0",cursor:"pointer",fontSize:18,display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"monospace"}}>‚àí</button>
        <span style={{fontSize:22,fontWeight:700,minWidth:34,textAlign:"center",color:col,fontVariantNumeric:"tabular-nums"}}>{value}</span>
        <button onClick={()=>onChange(value+1)} style={{width:28,height:28,borderRadius:6,border:"1px solid #2e3244",background:"#1a1d27",color:"#7b82a0",cursor:"pointer",fontSize:18,display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"monospace"}}>+</button>
        <span style={{fontSize:12,color:"#5a6080"}}>{unit}</span>
      </div>
      <div style={{height:3,background:"#2e3244",borderRadius:2}}>
        <div style={{width:`${pct*100}%`,height:"100%",background:col,borderRadius:2,transition:"width .35s,background .35s"}}/>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ Folder Tree (sidebar) ‚îÄ‚îÄ */
function FolderTree({ nodes, items, selectedId, onSelect, depth=0 }) {
  const [open, setOpen] = useState({});
  const toggle = id => setOpen(o=>({...o,[id]:!o[id]}));

  const countInSubtree = (node) => {
    const flat = flattenPaths([node]);
    const ids = flat.map(f=>f.id);
    return items.filter(i=>ids.includes(i.locationId)).length;
  };

  return nodes.map(node => {
    const hasChildren = node.children && node.children.length > 0;
    const isOpen = open[node.id];
    const isActive = selectedId === node.id;
    const total = countInSubtree(node);

    return (
      <div key={node.id}>
        <div
          onClick={()=>onSelect(node.id)}
          style={{display:"flex",alignItems:"center",gap:6,padding:`5px 8px 5px ${8+depth*14}px`,borderRadius:6,cursor:"pointer",background:isActive?"#252a3d":"transparent",color:isActive?"#7d9cf8":"#8892b0",marginBottom:1,transition:"background .12s",userSelect:"none"}}
        >
          {hasChildren
            ? <span onClick={e=>{e.stopPropagation();toggle(node.id);}} style={{color:"#3a4060",transform:isOpen?"rotate(90deg)":"rotate(0deg)",transition:"transform .15s",display:"flex",cursor:"pointer"}}>
                <Ic d={D.caret} size={13}/>
              </span>
            : <span style={{width:13,flexShrink:0}}/>
          }
          <span style={{color:isActive?"#7d9cf8":"#2e3a60"}}><Ic d={isOpen&&hasChildren?D.folderOpen:D.folder} size={13}/></span>
          <span style={{flex:1,fontSize:13,fontWeight:isActive?600:400,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{node.name}</span>
          {total>0&&<span style={{fontSize:10,background:isActive?"#4c6ef520":"#1a1d27",color:isActive?"#7d9cf8":"#3a4060",padding:"1px 6px",borderRadius:8,flexShrink:0}}>{total}</span>}
        </div>
        {isOpen&&hasChildren&&(
          <FolderTree nodes={node.children} items={items} selectedId={selectedId} onSelect={onSelect} depth={depth+1}/>
        )}
      </div>
    );
  });
}

/* ‚îÄ‚îÄ Location Tree Editor (settings) ‚îÄ‚îÄ */
function LocationEditor({ nodes, onAdd, onRename, onDelete }) {
  const [editing, setEditing] = useState(null);
  const [editVal, setEditVal] = useState("");
  const [adding, setAdding] = useState(null); // parentId or "root"
  const [addVal, setAddVal] = useState("");

  const startAdd = (parentId) => { setAdding(parentId); setAddVal(""); setEditing(null); };
  const confirmAdd = () => { if (addVal.trim()) { onAdd(adding==="root"?null:adding, addVal.trim()); } setAdding(null); setAddVal(""); };
  const startEdit = (id, name) => { setEditing(id); setEditVal(name); setAdding(null); };
  const confirmEdit = () => { if (editVal.trim()) { onRename(editing, editVal.trim()); } setEditing(null); };

  function renderNodes(list, depth=0) {
    return list.map(node => (
      <div key={node.id}>
        <div style={{display:"flex",alignItems:"center",gap:6,padding:`5px 8px 5px ${8+depth*18}px`,borderRadius:7,background:"#1a1d27",border:"1px solid #252a3d",marginBottom:4}}>
          <span style={{color:"#4c6ef5",flexShrink:0}}><Ic d={D.folder} size={13}/></span>
          {editing===node.id ? (
            <>
              <input autoFocus style={{...S.inp({flex:1,padding:"4px 8px",fontSize:13})}} value={editVal} onChange={e=>setEditVal(e.target.value)}
                onKeyDown={e=>{if(e.key==="Enter")confirmEdit();if(e.key==="Escape")setEditing(null);}}/>
              <button onClick={confirmEdit} style={S.btn("primary",{padding:"4px 10px",fontSize:12})}>‚úì</button>
              <button onClick={()=>setEditing(null)} style={S.btn("ghost",{padding:"4px 10px",fontSize:12})}>‚úï</button>
            </>
          ):(
            <>
              <span style={{flex:1,fontSize:13,color:"#dde1f0",fontWeight:500}}>{node.name}</span>
              <button title="Aggiungi sottocartella" onClick={()=>startAdd(node.id)} style={S.btn("icon")}><Ic d={D.plus} size={13} color="#4c6ef5"/></button>
              <button title="Rinomina" onClick={()=>startEdit(node.id,node.name)} style={S.btn("icon")}><Ic d={D.edit} size={13}/></button>
              <button title="Elimina" onClick={()=>onDelete(node.id)} style={S.btn("icon")}><Ic d={D.trash} size={13} color="#e05252"/></button>
            </>
          )}
        </div>
        {node.children&&node.children.length>0&&(
          <div style={{marginLeft:depth*4+4}}>
            {renderNodes(node.children, depth+1)}
          </div>
        )}
        {adding===node.id&&(
          <div style={{display:"flex",gap:6,marginBottom:6,paddingLeft:8+depth*18+18}}>
            <input autoFocus style={{...S.inp({flex:1,padding:"6px 10px",fontSize:13})}} value={addVal} onChange={e=>setAddVal(e.target.value)}
              placeholder="Nome sottocartella‚Ä¶"
              onKeyDown={e=>{if(e.key==="Enter")confirmAdd();if(e.key==="Escape")setAdding(null);}}/>
            <button onClick={confirmAdd} style={S.btn("primary",{padding:"6px 12px"})}>Aggiungi</button>
            <button onClick={()=>setAdding(null)} style={S.btn("ghost",{padding:"6px 10px"})}>‚úï</button>
          </div>
        )}
      </div>
    ));
  }

  return (
    <div>
      <div style={{display:"flex",flexDirection:"column",gap:0,marginBottom:10}}>
        {renderNodes(nodes)}
      </div>
      {adding==="root" ? (
        <div style={{display:"flex",gap:6}}>
          <input autoFocus style={{...S.inp({flex:1})}} value={addVal} onChange={e=>setAddVal(e.target.value)}
            placeholder="Nome cartella principale‚Ä¶"
            onKeyDown={e=>{if(e.key==="Enter")confirmAdd();if(e.key==="Escape")setAdding(null);}}/>
          <button onClick={confirmAdd} style={S.btn("primary")}>Aggiungi</button>
          <button onClick={()=>setAdding(null)} style={S.btn("ghost",{padding:"8px 10px"})}>‚úï</button>
        </div>
      ):(
        <button onClick={()=>startAdd("root")} style={{...S.btn("subtle",{width:"100%",padding:"9px",display:"flex",alignItems:"center",justifyContent:"center",gap:6})}}>
          <Ic d={D.plus} size={13}/> Nuova cartella principale
        </button>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ Item Form ‚îÄ‚îÄ */
function ItemForm({ initial, locationTree, tags, onSave, onCancel }) {
  const flatLocs = useMemo(()=>flattenPaths(locationTree),[locationTree]);
  const [form,setForm] = useState(initial||{name:"",quantity:1,unit:"confezioni",locationId:flatLocs[0]?.id||"",tags:[],notes:""});
  const [newTag,setNewTag] = useState("");
  const set = (k,v)=>setForm(f=>({...f,[k]:v}));
  const toggleTag = t=>set("tags",form.tags.includes(t)?form.tags.filter(x=>x!==t):[...form.tags,t]);
  const addCustomTag = ()=>{ const t=newTag.trim().toLowerCase(); if(t&&!form.tags.includes(t))set("tags",[...form.tags,t]); setNewTag(""); };
  return (
    <div>
      <h2 style={{margin:"0 0 20px",fontSize:20,fontWeight:700,color:"#dde1f0"}}>{initial?"Modifica":"Nuovo alimento"}</h2>
      <Lbl mt={0}>Nome</Lbl>
      <input style={S.inp()} value={form.name} onChange={e=>set("name",e.target.value)} placeholder="es. Farina 00" autoFocus/>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <div><Lbl>Quantit√†</Lbl><input style={S.inp()} type="number" min="0" step="0.5" value={form.quantity} onChange={e=>set("quantity",parseFloat(e.target.value)||0)}/></div>
        <div><Lbl>Unit√†</Lbl><select style={S.inp()} value={form.unit} onChange={e=>set("unit",e.target.value)}>{UNITS.map(u=><option key={u}>{u}</option>)}</select></div>
      </div>
      <Lbl>Posizione</Lbl>
      <select style={S.inp()} value={form.locationId} onChange={e=>set("locationId",e.target.value)}>
        {flatLocs.map(l=><option key={l.id} value={l.id}>{l.path}</option>)}
      </select>
      <Lbl>Tag</Lbl>
      <div style={{display:"flex",flexWrap:"wrap",gap:5,marginBottom:8}}>
        {tags.map(t=><TagPill key={t} label={t} active={form.tags.includes(t)} onClick={()=>toggleTag(t)} small/>)}
        {form.tags.filter(t=>!tags.includes(t)).map(t=><TagPill key={t} label={t} active small onRemove={()=>set("tags",form.tags.filter(x=>x!==t))}/>)}
      </div>
      <div style={{display:"flex",gap:8}}>
        <input style={{...S.inp({flex:1})}} value={newTag} onChange={e=>setNewTag(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addCustomTag()} placeholder="Aggiungi tag personalizzato‚Ä¶"/>
        <button onClick={addCustomTag} style={S.btn("subtle",{padding:"8px 14px"})}>+</button>
      </div>
      <Lbl>Note</Lbl>
      <textarea style={{...S.inp({resize:"vertical",minHeight:54})}} value={form.notes} onChange={e=>set("notes",e.target.value)} placeholder="Opzionale‚Ä¶"/>
      <div style={{display:"flex",gap:10,marginTop:20}}>
        <button onClick={()=>form.name.trim()&&onSave(form)} style={S.btn("primary")}>Salva</button>
        <button onClick={onCancel} style={S.btn("ghost")}>Annulla</button>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ Settings Modal ‚îÄ‚îÄ */
function SettingsModal({ locationTree, tags, onLocAdd, onLocRename, onLocDelete, onTagAdd, onTagDelete, onClose }) {
  const [tab,setTab] = useState("loc");
  const [newTag,setNewTag] = useState("");
  return (
    <Modal onClose={onClose} width={560}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
        <h2 style={{margin:0,fontSize:20,fontWeight:700,color:"#dde1f0"}}>Impostazioni</h2>
        <button onClick={onClose} style={S.btn("icon")}><Ic d={D.close}/></button>
      </div>
      <div style={{display:"flex",gap:4,marginBottom:20,background:"#1a1d27",borderRadius:8,padding:4}}>
        {[["loc","üìÇ Posizioni"],["tags","üè∑ Tag"]].map(([k,l])=>(
          <button key={k} onClick={()=>setTab(k)} style={{flex:1,padding:"7px",border:"none",borderRadius:6,fontFamily:"'DM Sans',sans-serif",fontSize:13,fontWeight:500,cursor:"pointer",background:tab===k?"#252a3d":"transparent",color:tab===k?"#7d9cf8":"#5a6080"}}>
            {l}
          </button>
        ))}
      </div>
      {tab==="loc"&&(
        <div>
          <div style={{fontSize:13,color:"#5a6080",marginBottom:14,lineHeight:1.5}}>
            Usa <strong style={{color:"#7d9cf8"}}>+</strong> accanto a una cartella per aggiungere una sottocartella. Puoi annidare quante vuoi.
          </div>
          <LocationEditor nodes={locationTree} onAdd={onLocAdd} onRename={onLocRename} onDelete={onLocDelete}/>
        </div>
      )}
      {tab==="tags"&&(
        <div>
          <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:14}}>
            {tags.map(t=><TagPill key={t} label={t} active onRemove={()=>onTagDelete(t)}/>)}
          </div>
          <div style={{display:"flex",gap:8}}>
            <input style={{...S.inp({flex:1})}} value={newTag} onChange={e=>setNewTag(e.target.value)}
              onKeyDown={e=>e.key==="Enter"&&newTag.trim()&&(onTagAdd(newTag.trim().toLowerCase()),setNewTag(""))}
              placeholder="Nuovo tag globale‚Ä¶"/>
            <button onClick={()=>{if(newTag.trim()){onTagAdd(newTag.trim().toLowerCase());setNewTag("");}}} style={S.btn("primary")}>Aggiungi</button>
          </div>
        </div>
      )}
    </Modal>
  );
}

/* ‚îÄ‚îÄ Grid Card ‚îÄ‚îÄ */
function GridCard({ item, locationLabel, onEdit, onDelete, onQty }) {
  const empty=item.quantity===0; const low=!empty&&item.quantity<=2;
  return (
    <div style={{background:"#161920",border:`1px solid ${empty?"#e0525222":low?"#f5a62322":"#22263a"}`,borderRadius:10,padding:16,transition:"border-color .18s"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
        <div style={{minWidth:0,flex:1}}>
          <div style={{fontSize:11,color:"#4c6ef5",marginBottom:3,fontWeight:500,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>üìÇ {locationLabel}</div>
          <div style={{fontSize:16,fontWeight:600,color:"#dde1f0",lineHeight:1.25,wordBreak:"break-word"}}>{item.name}</div>
          {item.notes&&<div style={{fontSize:12,color:"#5a6080",marginTop:2}}>{item.notes}</div>}
        </div>
        <div style={{display:"flex",gap:1,marginLeft:8,flexShrink:0}}>
          <button onClick={onEdit} style={S.btn("icon")}><Ic d={D.edit} size={13}/></button>
          <button onClick={onDelete} style={S.btn("icon")}><Ic d={D.trash} size={13} color="#e05252"/></button>
        </div>
      </div>
      <div style={{margin:"12px 0 10px"}}><QtyBar value={item.quantity} unit={item.unit} onChange={v=>onQty(v-item.quantity)}/></div>
      {empty&&<div style={{fontSize:11,color:"#e05252",fontWeight:700,marginBottom:8}}>‚ö† ESAURITO</div>}
      {low&&<div style={{fontSize:11,color:"#f5a623",fontWeight:600,marginBottom:8}}>‚ö† Scorta bassa</div>}
      <div style={{display:"flex",flexWrap:"wrap",gap:4}}>{item.tags.map(t=><TagPill key={t} label={t} small/>)}</div>
    </div>
  );
}

/* ‚îÄ‚îÄ List Row ‚îÄ‚îÄ */
function ListRow({ item, locationLabel, onEdit, onDelete, onQty }) {
  const empty=item.quantity===0; const low=!empty&&item.quantity<=2;
  const col=empty?"#e05252":low?"#f5a623":"#dde1f0";
  return (
    <div style={{display:"flex",alignItems:"center",gap:12,padding:"10px 14px",borderRadius:8,background:"#161920",border:`1px solid ${empty?"#e0525218":"#22263a"}`}}>
      <div style={{flex:2,minWidth:0}}>
        <div style={{fontSize:14,fontWeight:500,color:"#dde1f0",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{item.name}</div>
        <div style={{fontSize:11,color:"#5a6080",marginTop:1,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>üìÇ {locationLabel}{item.notes?" ¬∑ "+item.notes:""}</div>
      </div>
      <div style={{display:"flex",gap:4,flex:1,overflow:"hidden"}}>
        {item.tags.slice(0,3).map(t=><TagPill key={t} label={t} small/>)}
        {item.tags.length>3&&<span style={{fontSize:11,color:"#5a6080",alignSelf:"center"}}>+{item.tags.length-3}</span>}
      </div>
      <div style={{display:"flex",alignItems:"center",gap:5,flexShrink:0}}>
        <button onClick={()=>onQty(-1)} style={{width:25,height:25,borderRadius:5,border:"1px solid #2e3244",background:"#1a1d27",color:"#7b82a0",cursor:"pointer",fontSize:16,display:"flex",alignItems:"center",justifyContent:"center"}}>‚àí</button>
        <span style={{fontSize:15,fontWeight:700,minWidth:28,textAlign:"center",color:col,fontVariantNumeric:"tabular-nums"}}>{item.quantity}</span>
        <button onClick={()=>onQty(1)} style={{width:25,height:25,borderRadius:5,border:"1px solid #2e3244",background:"#1a1d27",color:"#7b82a0",cursor:"pointer",fontSize:16,display:"flex",alignItems:"center",justifyContent:"center"}}>+</button>
        <span style={{fontSize:12,color:"#5a6080",minWidth:50}}>{item.unit}</span>
      </div>
      <div style={{display:"flex",gap:1,flexShrink:0}}>
        <button onClick={onEdit} style={S.btn("icon")}><Ic d={D.edit} size={13}/></button>
        <button onClick={onDelete} style={S.btn("icon")}><Ic d={D.trash} size={13} color="#e05252"/></button>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
function App() {
  const [items,   setItems,   itemsReady]   = useFirebase("items",   DEFAULT_ITEMS);
  const [locTree, setLocTree, locTreeReady] = useFirebase("loctree", DEFAULT_LOCATIONS);
  const [tags,    setTags,    tagsReady]    = useFirebase("tags",    DEFAULT_TAGS);
  const syncReady = itemsReady && locTreeReady && tagsReady;

  // Timeout di sicurezza: se dopo 6s non si connette, mostra l'app comunque
  const [forceReady, setForceReady] = useState(false);
  useEffect(() => {
    const t = setTimeout(() => setForceReady(true), 6000);
    return () => clearTimeout(t);
  }, []);
  const appReady = syncReady || forceReady;

  const [search,setSearch]=useState("");
  const [selTag,setSelTag]=useState(null);       // tag selected WITHIN the tag page
  const [showTagPage,setShowTagPage]=useState(false); // "Tag" page open
  const [showLow,setShowLow]=useState(false);
  const [selLocId,setSelLocId]=useState(null);
  const [modal,setModal]=useState(null);
  const [delId,setDelId]=useState(null);
  const [showSettings,setShowSettings]=useState(false);
  const [view,setView]=useState("grid");

  const flatLocs = useMemo(()=>flattenPaths(locTree),[locTree]);
  const locMap = useMemo(()=>{const m={};flatLocs.forEach(l=>m[l.id]=l.path);return m;},[flatLocs]);

  // get all ids in subtree of selLocId
  const selSubtreeIds = useMemo(()=>{
    if(!selLocId) return null;
    const node = findNode(locTree, selLocId);
    if(!node) return null;
    return flattenPaths([node]).map(f=>f.id);
  },[selLocId,locTree]);

  const filtered = useMemo(()=>items.filter(item=>{
    const ms=!search||item.name.toLowerCase().includes(search.toLowerCase())||item.tags.some(t=>t.toLowerCase().includes(search.toLowerCase()));
    const ml=!selSubtreeIds||selSubtreeIds.includes(item.locationId);
    const mt=!selTag||item.tags.includes(selTag);
    const mq=!showLow||item.quantity<=2;
    return ms&&ml&&mt&&mq;
  }),[items,search,selSubtreeIds,selTag,showLow]);

  const usedTags=useMemo(()=>{const s=new Set();items.forEach(i=>i.tags.forEach(t=>s.add(t)));return[...s].sort();},[items]);
  const lowCount=items.filter(i=>i.quantity<=2).length;

  const saveItem=form=>{
    if(modal==="add") setItems(p=>[...p,{...form,id:Date.now()}]);
    else setItems(p=>p.map(i=>i.id===modal.id?{...form,id:modal.id}:i));
    setModal(null);
  };
  const deleteItem=id=>{setItems(p=>p.filter(i=>i.id!==id));setDelId(null);};
  const adjustQty=(id,d)=>setItems(p=>p.map(i=>i.id===id?{...i,quantity:Math.max(0,i.quantity+d)}:i));

  // location tree ops
  const locAdd=(parentId,name)=>{
    const child={id:genId(),name,children:[]};
    if(!parentId) setLocTree(p=>[...p,child]);
    else setLocTree(p=>addChildTo(p,parentId,child));
  };
  const locRename=(id,name)=>setLocTree(p=>renameNode(p,id,name));
  const locDelete=(id)=>{
    // reassign items
    const subtreeIds = flattenPaths([findNode(locTree,id)]).map(f=>f.id);
    setItems(p=>p.map(i=>subtreeIds.includes(i.locationId)?{...i,locationId:""}:i));
    setLocTree(p=>removeNode(p,id));
    if(selLocId===id) setSelLocId(null);
  };

  const tagAdd=t=>{if(!tags.includes(t))setTags(p=>[...p,t]);};
  const tagDelete=t=>setTags(p=>p.filter(x=>x!==t));

  const breadcrumb = selTag ? `#${selTag}` : showTagPage ? "Tag" : selLocId ? (flatLocs.find(f=>f.id===selLocId)?.path||"") : "Tutti gli alimenti";

  const [drawerOpen, setDrawerOpen] = useState(false);
  const [mobileTab, setMobileTab] = useState("all"); // all | low | tags | locations

  // sync mobileTab with existing filters
  const switchTab = (tab) => {
    setMobileTab(tab);
    if(tab==="all"){setSelLocId(null);setShowLow(false);setSelTag(null);setShowTagPage(false);}
    else if(tab==="low"){setShowLow(true);setSelTag(null);setSelLocId(null);setShowTagPage(false);}
    else if(tab==="tags"){setShowTagPage(true);setSelTag(null);setSelLocId(null);setShowLow(false);}
    else if(tab==="locations"){setDrawerOpen(true);}
  };

  return (
    <div style={{display:"flex",height:"100dvh",fontFamily:"'DM Sans',sans-serif",background:"#0f1117",color:"#dde1f0",overflow:"hidden"}}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap');
        *{box-sizing:border-box;margin:0;padding:0;}
        ::-webkit-scrollbar{width:5px;}
        ::-webkit-scrollbar-track{background:transparent;}
        ::-webkit-scrollbar-thumb{background:#2e3244;border-radius:3px;}
        input:focus,select:focus,textarea:focus{border-color:#4c6ef5!important;box-shadow:0 0 0 2px #4c6ef514;}
        button{font-family:'DM Sans',sans-serif;}
        button:hover{opacity:.8;}
        /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
        @media(max-width:768px){
          .desktop-sidebar{display:none!important;}
          .mobile-bottom-nav{display:flex!important;}
          .main-content{padding-bottom:calc(56px + env(safe-area-inset-bottom))!important;}
          .main-header{padding:10px 12px!important;padding-top:calc(10px + env(safe-area-inset-top))!important;}
          .main-header input{width:100%!important;}
          .search-wrapper{width:100%!important;flex:1!important;}
          .content-area{padding:10px 12px calc(72px + env(safe-area-inset-bottom)) 12px!important;}
          .modal-inner{
            position:fixed!important;
            bottom:0!important;left:0!important;right:0!important;
            top:auto!important;
            width:100%!important;
            max-width:100%!important;
            border-radius:16px 16px 0 0!important;
            max-height:92vh!important;
            padding-bottom:calc(20px + env(safe-area-inset-bottom))!important;
          }
          .modal-outer{align-items:flex-end!important;}
          .grid-cards{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))!important;}
          .mobile-title{display:block!important;}
        }
        @media(min-width:769px){
          .mobile-bottom-nav{display:none!important;}
          .mobile-drawer-overlay{display:none!important;}
        }
      `}</style>

      {/* LOADING iniziale */}
      {!appReady && (
        <div style={{position:"fixed",inset:0,background:"#0f1117",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:9999,gap:16}}>
          <div style={{fontSize:40}}>üè†</div>
          <div style={{fontSize:14,color:"#5a6080"}}>Connessione a Firebase‚Ä¶</div>
          <div style={{width:120,height:3,background:"#1e2233",borderRadius:2,overflow:"hidden"}}>
            <div style={{width:"40%",height:"100%",background:"#4c6ef5",borderRadius:2,animation:"fbload 1s ease-in-out infinite alternate"}}/>
          </div>
          <style>{`@keyframes fbload{from{margin-left:0}to{margin-left:60%}}`}</style>
        </div>
      )}

      {/* SIDEBAR */}
      <aside className="desktop-sidebar" style={{width:240,background:"#13151f",borderRight:"1px solid #1e2233",display:"flex",flexDirection:"column",flexShrink:0,overflow:"hidden"}}>
        <div style={{padding:"22px 16px 12px"}}>
          <div style={{fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.18em",color:"#4c6ef5",marginBottom:4}}>Gestione Casa</div>
          <div style={{fontSize:22,fontWeight:700,color:"#dde1f0",letterSpacing:"-0.02em"}}>Dispensa</div>
          <div style={{fontSize:12,color:"#2e3a5a",marginTop:3,display:"flex",alignItems:"center",gap:5}}>
            {items.length} alimenti
            <span title="Sincronizzato con Firebase" style={{display:"inline-flex",alignItems:"center",gap:3,fontSize:10,color:"#3ecf8e"}}>
              <span style={{width:6,height:6,borderRadius:"50%",background:"#3ecf8e",display:"inline-block"}}/>live
            </span>
          </div>
        </div>

        <nav style={{flex:1,overflowY:"auto",padding:"6px 10px"}}>
          {/* All */}
          <div onClick={()=>{setSelLocId(null);setShowLow(false);setSelTag(null);setShowTagPage(false);}} style={{display:"flex",alignItems:"center",gap:7,padding:"7px 8px",borderRadius:6,cursor:"pointer",background:!selLocId&&!showLow&&!showTagPage?"#1e2335":"transparent",color:!selLocId&&!showLow&&!showTagPage?"#7d9cf8":"#6878a0",marginBottom:1}}>
            <Ic d={D.grid} size={13} color={!selLocId&&!showLow&&!showTagPage?"#7d9cf8":"#2e3a60"}/> 
            <span style={{flex:1,fontSize:13,fontWeight:!selLocId&&!showLow&&!showTagPage?600:400}}>Tutti gli alimenti</span>
            <span style={{fontSize:10,background:"#1a1d27",color:"#3a4a70",padding:"1px 6px",borderRadius:8}}>{items.length}</span>
          </div>
          {/* Low */}
          <div onClick={()=>{setShowLow(p=>!p);setSelTag(null);setSelLocId(null);setShowTagPage(false);}} style={{display:"flex",alignItems:"center",gap:7,padding:"7px 8px",borderRadius:6,cursor:"pointer",background:showLow?"#1e2335":"transparent",color:showLow?"#f5a623":"#6878a0",marginBottom:1}}>
            <Ic d={D.warn} size={13} color={showLow?"#f5a623":"#2e3a60"}/>
            <span style={{flex:1,fontSize:13,fontWeight:showLow?600:400}}>Scorte basse</span>
            {lowCount>0&&<span style={{fontSize:10,background:"#f5a62320",color:"#f5a623",padding:"1px 6px",borderRadius:8}}>{lowCount}</span>}
          </div>
          {/* Tag page */}
          <div onClick={()=>{setShowTagPage(true);setSelTag(null);setSelLocId(null);setShowLow(false);}} style={{display:"flex",alignItems:"center",gap:7,padding:"7px 8px",borderRadius:6,cursor:"pointer",background:showTagPage?"#1e2335":"transparent",color:showTagPage?"#7d9cf8":"#6878a0",marginBottom:1}}>
            <span style={{fontSize:13,color:showTagPage?"#4c6ef5":"#2e3a60",fontWeight:700,flexShrink:0,lineHeight:1}}>#</span>
            <span style={{flex:1,fontSize:13,fontWeight:showTagPage?600:400}}>Tag</span>
            <span style={{fontSize:10,background:"#1a1d27",color:"#3a4a70",padding:"1px 6px",borderRadius:8}}>{usedTags.length}</span>
          </div>

          <div style={{fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.12em",color:"#1e2a4a",padding:"10px 8px 5px"}}>Posizioni</div>

          <FolderTree nodes={locTree} items={items} selectedId={selLocId}
            onSelect={id=>{setSelLocId(id===selLocId?null:id);setShowLow(false);setSelTag(null);setShowTagPage(false);}}/>
        </nav>

        <div style={{padding:"10px",borderTop:"1px solid #1e2233"}}>
          <button onClick={()=>setShowSettings(true)} style={{width:"100%",display:"flex",alignItems:"center",gap:8,background:"none",border:"none",cursor:"pointer",color:"#4a5270",padding:"8px 10px",borderRadius:6,fontSize:13}}>
            <Ic d={D.settings} size={14}/> Impostazioni
          </button>
        </div>
      </aside>

      {/* MAIN */}
      <div className="main-content" style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
        {/* Top bar */}
        <header className="main-header" style={{padding:"11px 18px",borderBottom:"1px solid #1e2233",display:"flex",gap:10,alignItems:"center",background:"#13151f",flexWrap:"wrap"}}>
          <div className="mobile-title" style={{fontSize:18,fontWeight:700,color:"#dde1f0",letterSpacing:"-0.02em",display:"none"}}>üè† Dispensa</div>
          <div className="search-wrapper" style={{position:"relative",width:260,flexShrink:0}}>
            <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:"#4a5270"}}><Ic d={D.search} size={14}/></span>
            <input style={{...S.inp({paddingLeft:32})}} placeholder="Cerca nome o tag‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)}/>
            {search&&<button onClick={()=>setSearch("")} style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#5a6080",fontSize:18}}>√ó</button>}
          </div>
          <div style={{flex:1}}/>
          <div style={{display:"flex",background:"#1a1d27",borderRadius:7,border:"1px solid #2e3244",overflow:"hidden",flexShrink:0}}>
            {["grid","list"].map(v=>(
              <button key={v} onClick={()=>setView(v)} style={{padding:"7px 10px",background:view===v?"#252a3d":"none",border:"none",cursor:"pointer",color:view===v?"#dde1f0":"#5a6080"}}>
                <Ic d={v==="grid"?D.grid:D.list} size={14}/>
              </button>
            ))}
          </div>
          <button onClick={()=>setModal("add")} style={{...S.btn("primary",{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap",flexShrink:0})}}>
            <Ic d={D.plus} size={14}/> Aggiungi
          </button>
        </header>

        {/* Breadcrumb */}
        <div style={{padding:"9px 18px",fontSize:12,color:"#4a5270",borderBottom:"1px solid #1a1d27",display:"flex",gap:8,alignItems:"center",background:"#11131c"}}>
          {selTag&&<button onClick={()=>setSelTag(null)} style={{background:"none",border:"none",cursor:"pointer",color:"#4c6ef5",fontSize:12,padding:0,display:"flex",alignItems:"center",gap:4}}>‚Üê Tag</button>}
          {selTag&&<span style={{color:"#1e2a3a"}}>/</span>}
          <span style={{color:"#5a6a90"}}>{showTagPage&&!selTag?"üè∑ Tag": selTag?`#${selTag}`:selLocId?"üìÇ "+breadcrumb:"üì¶ "+breadcrumb}</span>
          <span style={{color:"#1e2a3a"}}>¬∑</span>
          <span style={{color:"#3a4a70"}}>{showTagPage&&!selTag?`${usedTags.length} tag`:filtered.length+" elementi"}</span>
          {showLow&&<span style={{color:"#f5a623",fontWeight:600}}>¬∑ SCORTE BASSE</span>}
        </div>

        {/* Content */}
        <main className="content-area" style={{flex:1,overflowY:"auto",padding:"14px 18px 28px"}}>
          {/* TAG PAGE */}
          {showTagPage&&!selTag?(
            usedTags.length===0?(
              <div style={{textAlign:"center",color:"#2e3a5a",marginTop:80,fontSize:16}}>Nessun tag in uso.</div>
            ):view==="grid"?(
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(160px,1fr))",gap:12}}>
                {usedTags.map(t=>{
                  const count=items.filter(i=>i.tags.includes(t)).length;
                  const lowInTag=items.filter(i=>i.tags.includes(t)&&i.quantity<=2).length;
                  return (
                    <div key={t} onClick={()=>setSelTag(t)} style={{background:"#161920",border:"1px solid #22263a",borderRadius:10,padding:"20px 16px",cursor:"pointer",transition:"border-color .15s",userSelect:"none"}}
                      onMouseEnter={e=>e.currentTarget.style.borderColor="#4c6ef5"}
                      onMouseLeave={e=>e.currentTarget.style.borderColor="#22263a"}>
                      <div style={{fontSize:22,fontWeight:700,color:"#4c6ef5",marginBottom:6}}>#</div>
                      <div style={{fontSize:15,fontWeight:600,color:"#dde1f0",marginBottom:10,wordBreak:"break-word"}}>{t}</div>
                      <div style={{fontSize:12,color:"#4a5270"}}>{count} aliment{count===1?"o":"i"}</div>
                      {lowInTag>0&&<div style={{fontSize:11,color:"#f5a623",marginTop:4,fontWeight:500}}>‚ö† {lowInTag} in esaurimento</div>}
                    </div>
                  );
                })}
              </div>
            ):(
              <div style={{display:"flex",flexDirection:"column",gap:4}}>
                {usedTags.map(t=>{
                  const count=items.filter(i=>i.tags.includes(t)).length;
                  const lowInTag=items.filter(i=>i.tags.includes(t)&&i.quantity<=2).length;
                  return (
                    <div key={t} onClick={()=>setSelTag(t)} style={{display:"flex",alignItems:"center",gap:14,padding:"11px 16px",borderRadius:8,background:"#161920",border:"1px solid #22263a",cursor:"pointer",transition:"border-color .15s"}}
                      onMouseEnter={e=>e.currentTarget.style.borderColor="#4c6ef5"}
                      onMouseLeave={e=>e.currentTarget.style.borderColor="#22263a"}>
                      <span style={{fontSize:18,fontWeight:700,color:"#4c6ef5",width:24,textAlign:"center"}}>#</span>
                      <span style={{flex:1,fontSize:14,fontWeight:600,color:"#dde1f0"}}>{t}</span>
                      {lowInTag>0&&<span style={{fontSize:11,color:"#f5a623",fontWeight:500}}>‚ö† {lowInTag} in esaurimento</span>}
                      <span style={{fontSize:12,color:"#4a5270"}}>{count} aliment{count===1?"o":"i"}</span>
                    </div>
                  );
                })}
              </div>
            )
          ):(
            /* NORMAL ITEMS VIEW */
            filtered.length===0?(
              <div style={{textAlign:"center",color:"#2e3a5a",marginTop:80,fontSize:16}}>Nessun alimento trovato.</div>
            ):view==="grid"?(
              <div className="grid-cards" style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(228px,1fr))",gap:12}}>
                {filtered.map(item=>(
                  <GridCard key={item.id} item={item} locationLabel={locMap[item.locationId]||"‚Äî"}
                    onEdit={()=>setModal(item)} onDelete={()=>setDelId(item.id)} onQty={d=>adjustQty(item.id,d)}/>
                ))}
              </div>
            ):(
              <div style={{display:"flex",flexDirection:"column",gap:4}}>
                {filtered.map(item=>(
                  <ListRow key={item.id} item={item} locationLabel={locMap[item.locationId]||"‚Äî"}
                    onEdit={()=>setModal(item)} onDelete={()=>setDelId(item.id)} onQty={d=>adjustQty(item.id,d)}/>
                ))}
              </div>
            )
          )}
        </main>
      </div>

      {/* MODALS */}
      {modal&&(
        <Modal onClose={()=>setModal(null)}>
          <ItemForm initial={modal==="add"?null:modal} locationTree={locTree} tags={tags} onSave={saveItem} onCancel={()=>setModal(null)}/>
        </Modal>
      )}
      {delId&&(
        <Modal onClose={()=>setDelId(null)} width={360}>
          <div style={{textAlign:"center"}}>
            <div style={{fontSize:36,marginBottom:12}}>üóë</div>
            <h3 style={{fontSize:18,color:"#dde1f0",marginBottom:8,fontWeight:600}}>Eliminare l'alimento?</h3>
            <p style={{color:"#5a6080",marginBottom:24,fontSize:14}}>Operazione non reversibile.</p>
            <div style={{display:"flex",gap:10,justifyContent:"center"}}>
              <button onClick={()=>deleteItem(delId)} style={S.btn("danger")}>Elimina</button>
              <button onClick={()=>setDelId(null)} style={S.btn("ghost")}>Annulla</button>
            </div>
          </div>
        </Modal>
      )}
      {showSettings&&(
        <SettingsModal locationTree={locTree} tags={tags}
          onLocAdd={locAdd} onLocRename={locRename} onLocDelete={locDelete}
          onTagAdd={tagAdd} onTagDelete={tagDelete}
          onClose={()=>setShowSettings(false)}/>
      )}

      {/* MOBILE LOCATION DRAWER */}
      {drawerOpen&&(
        <div onClick={()=>setDrawerOpen(false)} className="mobile-drawer-overlay" style={{position:"fixed",inset:0,background:"rgba(0,0,0,.6)",zIndex:200,backdropFilter:"blur(3px)"}}>
          <div onClick={e=>e.stopPropagation()} style={{position:"fixed",left:0,top:0,bottom:0,width:"80vw",maxWidth:320,background:"#13151f",borderRight:"1px solid #1e2233",display:"flex",flexDirection:"column",zIndex:201,overflowY:"auto",paddingBottom:"env(safe-area-inset-bottom)"}}>
            <div style={{padding:"20px 16px 10px",paddingTop:"calc(20px + env(safe-area-inset-top))",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{fontSize:18,fontWeight:700,color:"#dde1f0"}}>Posizioni</div>
              <button onClick={()=>setDrawerOpen(false)} style={{background:"none",border:"none",cursor:"pointer",color:"#5a6080",fontSize:22,padding:4}}>√ó</button>
            </div>
            <div style={{padding:"0 10px",flex:1,overflowY:"auto"}}>
              <div onClick={()=>{setSelLocId(null);setShowLow(false);setSelTag(null);setShowTagPage(false);setDrawerOpen(false);setMobileTab("all");}} style={{display:"flex",alignItems:"center",gap:7,padding:"10px 8px",borderRadius:6,cursor:"pointer",background:"transparent",color:"#6878a0",marginBottom:1}}>
                <Ic d={D.grid} size={14} color="#2e3a60"/>
                <span style={{flex:1,fontSize:14}}>Tutti gli alimenti</span>
                <span style={{fontSize:10,background:"#1a1d27",color:"#3a4a70",padding:"1px 6px",borderRadius:8}}>{items.length}</span>
              </div>
              <div style={{fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.12em",color:"#1e2a4a",padding:"10px 8px 5px"}}>Posizioni</div>
              <FolderTree nodes={locTree} items={items} selectedId={selLocId}
                onSelect={id=>{setSelLocId(id===selLocId?null:id);setShowLow(false);setSelTag(null);setShowTagPage(false);setDrawerOpen(false);setMobileTab("locations");}}/>
            </div>
            <div style={{padding:"10px",borderTop:"1px solid #1e2233"}}>
              <button onClick={()=>{setShowSettings(true);setDrawerOpen(false);}} style={{width:"100%",display:"flex",alignItems:"center",gap:8,background:"none",border:"none",cursor:"pointer",color:"#4a5270",padding:"10px",borderRadius:6,fontSize:13,minHeight:44}}>
                <Ic d={D.settings} size={14}/> Impostazioni
              </button>
            </div>
          </div>
        </div>
      )}

      {/* MOBILE BOTTOM NAV */}
      <nav className="mobile-bottom-nav" style={{
        display:"none",position:"fixed",bottom:0,left:0,right:0,
        background:"#13151f",borderTop:"1px solid #1e2233",
        zIndex:100,justifyContent:"space-around",alignItems:"stretch",
        flexDirection:"column",
        paddingBottom:"env(safe-area-inset-bottom)"
      }}>
        <div style={{display:"flex",justifyContent:"space-around",alignItems:"center"}}>
        {[
          {tab:"all",icon:D.grid,label:"Tutti"},
          {tab:"low",icon:D.warn,label:"Scorte"},
          {tab:"tags",icon:null,label:"Tag",isHash:true},
          {tab:"locations",icon:D.folder,label:"Posizioni"},
        ].map(({tab,icon,label,isHash})=>{
          const active = tab==="locations" ? !!selLocId : (tab==="all"&&!selLocId&&!showLow&&!showTagPage) || (tab==="low"&&showLow) || (tab==="tags"&&showTagPage);
          return (
            <button key={tab} onClick={()=>switchTab(tab)} style={{
              flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",
              gap:3,padding:"10px 4px",background:"none",border:"none",cursor:"pointer",
              color:active?"#7d9cf8":"#4a5270",minHeight:56,transition:"color .15s"
            }}>
              {isHash
                ? <span style={{fontSize:18,fontWeight:700,lineHeight:1,color:active?"#4c6ef5":"#3a4060"}}>#</span>
                : <Ic d={icon} size={20} color={active?"#7d9cf8":"#3a4060"}/>
              }
              <span style={{fontSize:10,fontWeight:active?600:400}}>{label}</span>
              {tab==="low"&&lowCount>0&&<span style={{position:"absolute",top:8,fontSize:9,background:"#f5a623",color:"#000",borderRadius:8,padding:"1px 4px",fontWeight:700}}>{lowCount}</span>}
            </button>
          );
        })}
        <button onClick={()=>setModal("add")} style={{
          flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",
          gap:3,padding:"10px 4px",background:"none",border:"none",cursor:"pointer",
          color:"#4c6ef5",minHeight:56
        }}>
          <div style={{width:32,height:32,borderRadius:8,background:"#4c6ef5",display:"flex",alignItems:"center",justifyContent:"center"}}>
            <Ic d={D.plus} size={18} color="#fff"/>
          </div>
          <span style={{fontSize:10,fontWeight:600}}>Aggiungi</span>
        </button>
        </div>
      </nav>
    </div>
  );
}


ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
